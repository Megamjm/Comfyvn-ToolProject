ComfyVN — Architecture Update Notes (2025-10-21)
================================================

Scope: Snapshot of recent local changes and alignment tasks against `ARCHITECTURE.md`.

- Live Fixes — Server Boot & Tools Panels (2025-10-22): Detached launches now shell out to `python -m uvicorn comfyvn.app:app` with the repo root injected into `PYTHONPATH`, mirroring runtime authority rollover. Liability acknowledgements persist to `config/policy_ack.json`, `/api/policy/ack` returns `{ack,status,message}`, and callers can raise `PermissionError` via `require_ack_or_raise`. Studio’s Tools menu exposes interactive JSON endpoint testers (`comfyvn/gui/panels/json_endpoint_panel.py`) for SillyTavern chat/persona/lore imports, FurAffinity drops, Ren’Py export previews, and remote installer plans; Settings is also available as a modal dialog. CLI utilities (`tools/check_current_system.py`, `tools/doctor_phase_all.py`) share the new `discover_base()` helper so scripted diagnostics follow the same CLI/env/config/fallback order. Docs touched: README highlights, CHANGELOG entry, help menu wiring to local docs.
- Desktop Settings — Port Binding (2025-12-24): Introduced the `comfyvn/gui/settings/network_panel.py` widget so Studio exposes launcher host/port/public base overrides without hand-editing JSON. The panel hits `/api/settings/ports/{get,set,probe}`, mirrors runtime authority resolution (`comfyvn/config/baseurl_authority.py`), and surfaces probe results so operators know which port responded first. Docs added: `docs/PORTS_ROLLOVER.md` (runtime state + curl drills), `docs/dev_notes_network_ports.md` (integration guidance), plus refreshed README + architecture docs. Checker: extend `tools/check_current_system.py` with a `p5_settings_ports` profile once backend endpoints land.
- License/EULA Snapshot Gate (2025-12-22): Added `comfyvn/advisory/license_snapshot.py` to capture normalised hub licences, persist `license_snapshot.json` next to assets (or `data/license_snapshots/<slug>/` during staging), and store per-user acknowledgements with provenance in settings. New FastAPI surface `comfyvn/server/routes/advisory_license.py` exposes `/api/advisory/license/{snapshot,ack,require}` plus a status reader so connectors and automation can block downloads until hashes are acknowledged. Modder hook `on_asset_meta_updated` now carries `meta.license_snapshot` + `meta.license_ack` envelopes for dashboards. Docs sweep: `docs/ADVISORY_LICENSE_SNAPSHOT.md`, `docs/dev_notes_license_snapshot.md`, README + architecture refresh, CHANGELOG entry, and checker profile `p7_license_eula_enforcer`.
- Translation Manager & TM Review (2025-10-22): `comfyvn/translation/manager.py` now consults the persistent TM before falling back to JSON tables, and `comfyvn/translation/tm_store.py` tracks versioned entries (`{key -> {lang -> text, meta, hits, confidence, reviewer}}`) under `config/i18n/tm.json`. FastAPI routes (`comfyvn/server/routes/translation.py`) consolidate around `/api/translate/batch`, `/api/translate/review` (GET/POST), and scoped exports with embedded debug links. Architecture impact: live language switching is fully API driven (Viewer + Studio), TM metadata can be filtered by `asset`/`component`, and exports optionally embed meta for automation. See `docs/TRANSLATION_MANAGER.md` for curl recipes and workflow diagrams; `docs/dev_notes_translation_tm_review.md` was updated with the new data model, versioning notes, and QA plan.
- Editor Blocking Assistant & Snapshot Sheets (2025-12-21): Introduced `comfyvn/editor/{blocking_assistant,snapshot_sheet}.py` plus `comfyvn/server/routes/editor.py` gated by `enable_blocking_assistant` / `enable_snapshot_sheets` (both default OFF). New modder hooks `on_blocking_suggested` and `on_snapshot_sheet_rendered` expose deterministic digests for automation. Outputs land in `exports/snapshot_sheets/`. Docs sweep: new `docs/EDITOR_UX_ADVANCED.md`, new `docs/development/dev_notes_editor_blocking.md`, refreshed `README.md`, `architecture.md`, and `CHANGELOG.md`. Checker profile `p6_editor_ux` validates flags, routes, and doc coverage.
- Hugging Face Hub Connector (2025-12-21): Added `comfyvn/public_providers/hf_hub.py` plus the FastAPI router `comfyvn/server/routes/providers_hf.py` behind `enable_public_model_hubs`. The surface exposes `/api/providers/hf/{health,search,metadata}` and a dry-run `/pull` planner that requires both an `hf_*` PAT and an explicit license acknowledgement. Payloads normalise card metadata, license hints, tags, and file inventories (flagging files >= 1 GiB) so Studio panels and modder tooling can reason about Hub assets without downloading them. Secrets resolve via env (`HF_TOKEN`, `HF_API_TOKEN`, `HUGGINGFACEHUB_API_TOKEN`, `HUGGINGFACEHUB_TOKEN`) or `config/comfyvn.secrets.json` (`hf_hub.token/api_token/hf_token`). Docs: `docs/PROVIDERS_HF_HUB.md`, README + CHANGELOG updates, checker profile `p7_connectors_huggingface`.

- Web Publish & Redaction Preview (2025-12-20): Introduced `comfyvn/exporters/web_packager.py` for deterministic Mini-VN web bundles (SHA-256 asset hashing, redaction summaries, health snapshots) plus `comfyvn/server/routes/publish.py` exposing `/api/publish/web/{build,redact,preview}` behind `features.enable_publish_web`. Bundles land under `exports/publish/web/` with `*.web.{zip,manifest.json,content_map.json,preview.json,redaction.json}` and optional `*.web.hooks.json` when `include_debug` is set. Documentation sweep: new `docs/PUBLISH_WEB.md`, new `docs/dev_notes_publish_web.md`, refreshed `README.md`, `architecture.md`, and `CHANGELOG.md`. Checker profile `p6_publish_web` validates flag/route/doc coverage; QA can diff health + redaction sidecars to confirm expected asset removals.
- Persona Importer & NSFW Gating (2025-12-18): Added `comfyvn/persona/{schema.py,importers/community.py}` with consent-aware schema helpers, markdown/JSON parsing, and NSFW trimming plus new FastAPI routes `comfyvn/server/routes/persona.py` (`/api/persona/{consent,import/text,import/images,map,preview}`) behind `features.enable_persona_importers`. Image uploads persist hashed assets + `.meta.json` sidecars and queue `persona.image2persona` jobs; persona mapping writes `data/characters/<id>/persona.json` alongside provenance sidecars and emits the `on_persona_imported` modder hook. Docs: `docs/PERSONA_IMPORTERS.md`, `docs/NSFW_GATING.md`, `docs/dev_notes_persona_importers.md`, README + architecture refresh. Checker profile `p6_persona_importers` validates flag defaults, route presence, and documentation coverage (flags remain **off** by default).
- Community Connectors — F-List & FurAffinity (2025-12-23): Introduced `comfyvn/connectors/{flist,furaffinity}.py` plus the FastAPI router `comfyvn/server/routes/connectors_persona.py` under `features.enable_persona_importers`. `/api/connect/flist/consent|import_text` normalise F-List markdown into persona schemas, `/api/connect/furaffinity/upload` stores user-supplied images with hashed filenames + provenance sidecars, and `/api/connect/persona/map` merges text/image traits before persisting persona + provenance JSON. Consent JSON (`data/persona/consent.json`) now stores `connectors.flist` metadata (rights, profile URL, NSFW allowance). New modder hooks `on_flist_profile_parsed`, `on_furaffinity_asset_uploaded`, and `on_connector_persona_mapped` broadcast parsed payloads + asset metadata. Docs: `docs/COMMUNITY_CONNECTORS.md`, refreshed `docs/NSFW_GATING.md`, new `docs/dev_notes_community_connectors.md`, README + architecture updates. Checker profile `p7_connectors_flist_fa` validates flags, routes, and documentation (flags remain **off** by default).
- Image→Persona Analyzer (2025-12-17): Introduced `comfyvn/persona/image2persona.py` for deterministic appearance tagging, palette extraction, pose anchors, and expression clustering plus `comfyvn/persona/style_suggestions.py` for registry-driven style/LoRA hints. Outputs merge into persona metadata (`metadata.image2persona`) with provenance hashes and conflict reports. New docs `docs/IMAGE2PERSONA.md` and `docs/dev_notes_image2persona.md` capture the pipeline, hook catalog, QA plan, and script snippets. README + architecture docs now flag the `enable_image2persona` feature flag (default **false**) and reference the `p6_image2persona` checker profile.
- 2.5D Animation Rig (2025-12-19): Added `comfyvn/anim/rig/autorig.py` for anchor→bone conversion, constraint derivation, idle cycle generation, and mouth shape synthesis alongside `comfyvn/anim/rig/mograph.py` for guarded motion graph sequencing (idle→turn→emote). FastAPI routes live under `comfyvn/server/routes/anim.py` exposing `/api/anim/{rig,preview,save}` with feature flag `enable_anim_25d` and preset storage in `cache/anim_25d_presets.json`. Documentation sweep: new `docs/ANIM_25D.md`, new `docs/dev_notes_anim_25d.md`, updated `README.md`, `architecture.md`, and `CHANGELOG.md`. Modder hooks `on_anim_rig_generated`, `on_anim_preview_generated`, `on_anim_preset_saved` register with the central bus for dashboards and automation. Checker profile `p6_anim_25d` enforces flag/route/doc coverage.
- Advisory Gate & Studio Bundle Export (2025-12-17): Added `comfyvn/server/routes/advisory.py` for policy acknowledgement and advisory scanning, plus `comfyvn/server/routes/export.py::/bundle/status` for flag/gate probes. `comfyvn/advisory/{policy,scanner}.py` now expose an `evaluate_action` helper and deterministic finding ordering; `scripts/export_bundle.py` enforces `enable_export_bundle`, surfaces enforcement JSON/log paths, and aligns with the API contract. Docs: new `docs/ADVISORY_EXPORT.md`, new `docs/dev_notes_advisory_export.md`, refreshed `README.md`, `architecture.md`, and `CHANGELOG.md`. Checker profile `p5_advisory_export` validates flags, routes, and documentation coverage.
- Compute Advisor & Cost Hints (2025-12-18): `comfyvn/compute/advisor.py` gains optional debug payloads, `ProviderRegistry.stats()` surfaces provider counts, and `JobScheduler.preview_cost()` introduces human-friendly cost previews. `/api/gpu/list`, `/api/providers`, `/api/compute/advise`, and the new `/api/compute/costs` endpoints now accept `debug` toggles and echo the `enable_compute` flag state while defaulting it to **false** to keep remote offload opt-in. Docs refreshed: `docs/COMPUTE_ADVISOR.md`, `docs/dev_notes_compute_advisor.md`, `README.md`, `architecture.md`, and `CHANGELOG.md`.
- Audio Lab TTS Alignment & Mixer Refresh (2025-12-16): Introduced the gated Audio Lab surface behind `features.enable_audio_lab` with a stub voice catalog (`GET /api/tts/voices`), enriched `/api/tts/speak` responses (alignment checksum, lipsync metadata, provenance), a dedicated `/api/audio/align` route, and deterministic mixer sidecars that record waveform checksums, peaks, and render timestamps. Modder hooks `on_audio_tts_cached`, `on_audio_alignment_generated`, and `on_audio_mix_rendered` broadcast cache events for dashboards and automation. Documentation sweep: new `docs/AUDIO_LAB.md`, refreshed `README.md`, `architecture.md`, `architecture_updates.md`, `docs/dev_notes_audio_alignment_mixer.md`, and `CHANGELOG.md`. Checker profile `p5_audio_lab` now validates flag defaults, voice/tts/align/mix routes, and doc coverage while keeping the flag off by default.
- Cloud Sync & Backups Refresh (2025-12-15): Refined `comfyvn/sync/cloud/manifest.py` with default include/exclude sets, checksum helpers, and partial-failure aware `SyncApplyError`. Provider adapters (`s3.py`, `gdrive.py`) now aggregate per-object errors, return structured summaries, and only upload manifests on clean runs. FastAPI moved to `comfyvn/server/routes/sync_cloud.py`, exposing `/api/sync/manifest`, `/api/sync/dry_run`, `/api/sync/run`, and local backup endpoints `/api/backup/{create,restore}` with rotation under `backups/cloud/`. Documentation sweep: new `docs/CLOUD_SYNC.md`, new `docs/BACKUPS.md`, refreshed `README.md`, `architecture.md`, `CHANGELOG.md`, and updated dev note `docs/development/dev_notes_cloud_sync.md`. Checker profile `p4_cloud_sync` covers flags, routes, and docs.
- Live Collaboration Headless API (2025-12-12): `comfyvn/collab/room.py` gained `register_headless_client()` so REST callers can reserve presence slots, update cursors/selections, and participate in the soft-lock queue without holding a WebSocket. Presence payloads now expose a `headless` flag, and `room.leave()` reports whether a client was removed so HTTP flows can confirm teardown. `comfyvn/server/routes/collab.py` exposes the new `/api/collab/room/{create,join,leave,apply}` routes plus `room/cache`, mirroring the WebSocket envelopes and wiring modder hooks (`on_collab_operation`) for debug dashboards. Docs refreshed across `README.md`, `architecture.md`, `docs/COLLAB_EDITING.md`, and `CHANGELOG.md`; regression coverage expands `tests/test_collab_api.py` to exercise the REST lifecycle.
- Accessibility UI Scale & Input Presets (2025-12-14): Added `comfyvn/accessibility/ui_scale.py` and extended the accessibility manager to persist global UI scale presets (100–200 %) with per-view overrides. VN Viewer registers with the new manager so viewer-only overrides apply alongside filter/high-contrast/subtitle changes. `SettingsManager.DEFAULTS["input_map"]` now includes numeric choice bindings, narrator/overlay toggles, and an editor pick-winner shortcut; `InputMapManager` gained export/import helpers plus reset/import `reason` metadata for modder hooks. FastAPI added `/api/accessibility/{set,export,import}` and `/api/input/{map,reset}`; new docs (`docs/ACCESSIBILITY.md`, `docs/INPUT_SCHEMES.md`) and updates to `README.md`, `architecture.md`, `architecture_updates.md`, and `docs/development/accessibility_input_profiles.md` capture presets, API payloads, and debug hooks. Feature flag `enable_accessibility` defaults **false** so deployments can stage the stack before exposing the surface.
- Dungeon Runtime & Snapshot Hooks (2025-12-11): Landed `comfyvn/dungeon/api.py` with grid + DOOM-lite backends and the `/api/dungeon/{enter,step,encounter_start,resolve,leave}` FastAPI routes, gated by `features.enable_dungeon_api` (default **false**). Responses surface deterministic `room_state`, `snapshot`, and `vn_snapshot` payloads so Snapshot→Node/Fork consumers preserve event anchors. Modder hooks `on_dungeon_enter`, `on_dungeon_snapshot`, and `on_dungeon_leave` were added to the bus for automation dashboards. Documentation sweep: new `docs/DUNGEON_API.md`, companion dev note `docs/dev_notes_dungeon_api.md`, and updates to `README.md`, `architecture.md`, and `CHANGELOG.md`. Checker profile `p3_dungeon` validates flag defaults, routes, and docs.
- Observability & Perf Umbrella Flags (2025-12-10): Introduced `features.enable_observability` and `features.enable_perf` as the canonical toggles for telemetry/diagnostics and perf budgets/profiler dashboards. Telemetry API picked up `/api/telemetry/health` and `/api/telemetry/opt_in`, response payloads echo `feature_flag`, and diagnostics bundles embed consent + health snapshots. Budget manager + profiler return lightweight `health()` summaries and `/api/perf/health` aggregates queue pressure with top span offenders for smoke checks. Settings panel updates both umbrella and legacy aliases so Studio UI stays in sync. Docs refreshed across `README.md`, `architecture.md`, `CHANGELOG.md`, `docs/OBS_TELEMETRY.md`, `docs/PERF_BUDGETS.md`, `docs/dev_notes_observability_perf.md`, and existing observability/perf dev notes.
- Public Language Providers & LLM Router (2025-12-10): Added dry-run adapters for Google/DeepL/Amazon MT, Google Vision/AWS Rekognition OCR, Deepgram/AssemblyAI speech, and OpenAI/Anthropic/Gemini/OpenRouter LLM providers. `/api/providers/translate/health` and `/api/providers/llm/registry` surface pricing links, last-checked timestamps, and credential diagnostics while keeping traffic off. `POST /api/providers/translate/public` and `POST /api/providers/llm/chat` echo routing plans so modders can inspect payloads without keys. Docs refreshed (`README.md`, `architecture.md`, `CHANGELOG.md`, `docs/PROVIDERS_LANG_SPEECH_LLM.md`, `docs/LLM_RECOMMENDATIONS.md`, `docs/dev_notes_public_language_providers.md`), and the Phase 3 checker profile gained coverage via `tools/check_current_system.py --profile p3_providers_lang_speech_llm`.
- Public GPU & Media Providers Refresh (2025-12-10): Introduced GPU adapters for RunPod, Hugging Face Inference Endpoints, Replicate, and Modal plus refreshed image/video modules (Stability, fal.ai, Runway, Pika, Luma) with `metadata()`, `health()`, `submit()`, and `poll()` dry-run helpers. FastAPI routes now expose `/api/providers/gpu/public/{provider}/{health,submit,poll}` alongside `/api/providers/{image,video}/{provider}/{health,submit,poll}`, returning `pricing_url`, `last_checked`, capability tags, and feature-flag context with deterministic mock ids. Docs updated (`README.md`, `docs/PROVIDERS_GPU_IMAGE_VIDEO.md`, `docs/dev_notes_public_media_providers.md`, `architecture_updates.md`, `CHANGELOG.md`), and checker profile `p3_providers_gpu_image_video` validates catalog + health responses without network calls.
- Viewer Stack Failover & Export Provenance (2025-12-08): `/api/viewer/status` now auto-promotes Ren'Py fallbacks (native → webview → Mini-VN) whenever the native process exits, keeping the Qt embed responsive without another start call. The Mini-VN thumbnailer emits deterministic 16:9 captures and raises `on_thumbnail_captured` so modders can mirror caches. Ren'Py CLI exports drop `label_manifest.json`, `provenance_bundle.zip`, and a flattened `provenance.json`; CLI summaries and `on_export_completed` now surface provenance paths/findings for downstream automation. Docs refreshed (`README.md`, `docs/EXPORT_RENPY.md`, `docs/dev_notes_viewer_stack.md`, `architecture_updates.md`, `CHANGELOG.md`).
- Battle UX (Editor Pick) & Game Sim v0 (2025-12-08): `comfyvn/battle/engine.py` now funnels both Editor and Game flows through a shared deterministic core. `resolve()` accepts `rounds`/`narrate`, returns breakdowns, RNG state, provenance, and predicted outcome alongside the editor override. `simulate()` exposes the same payload (narration optional) and backs the new `/api/battle/sim` route (feature-flagged; `/simulate` aliases remain). Server hooks broadcast the expanded envelopes (`weights`, `breakdown`, `rng`, `provenance`, `predicted_outcome`, `narrate`, `rounds`). Docs refreshed across `README.md`, `architecture.md`, `docs/BATTLE_DESIGN.md`, `docs/development/battle_layer_hooks.md`, `docs/dev_notes_modder_hooks.md`, `docs/PROMPT_PACKS/BATTLE_NARRATION.md`, and a new dev note covers integration/testing guidance; `CHANGELOG.md` logs the work and tools/checker profile `p2_battle` now asserts `/api/battle/sim`.
- Extractor Installer & VN Wrapper (2025-10-22): Added `tools/install_third_party.py` (ack-gated downloader with manifest + shims), `tools/vn_extract.py` (engine detection, per-archive execution, licence snapshots), and `tools/doctor_extractors.py` (shim health probes). New doc `docs/EXTRACTORS.md` captures legal notes, debug hooks, and automation guidance; README gains an “Importing Existing VNs” quick-start section and CHANGELOG logs the work. Feature flag `enable_extractors` stays off until surfaced in Studio. Manifest + log artefacts provide provenance for downstream automation/QA.
- Flat → Layers Pipeline (2025-12-04): Introduced `comfyvn/pipelines/flat2layers.py` as the orchestration layer between rembg/SAM/MiDaS/LaMa/Real-ESRGAN components. The pipeline emits provenance sidecars for every artifact, exposes deterministic hook events (`on_mask_ready`, `on_plane_exported`, `on_complete`, `on_debug`), and writes exports under `layered/{character,background}`. Supporting CLI (`tools/depth_planes.py`) feeds tuned thresholds into the pipeline, while Playground SAM brushes push refinement events over the `flat2layers.sam` channel. Docs (`docs/FLAT_TO_LAYERS.md`, `README.md`, `docs/development_notes.md`, `CHANGELOG.md`) describe the flow, feature flag default (`enable_flat2layers = false`), and modder integration notes.
- Narrator Outliner & Role Mapping (2025-12-06): Landed `comfyvn/server/routes/narrator.py` with Observe → Propose → Apply rails (deterministic proposal queue, three-turn cap, rollback history) and the companion `comfyvn/llm/orchestrator.py` role→adapter planner. VN Chat now binds to `/api/narrator/*` and defaults to the offline adapter unless `features.enable_llm_role_mapping` assigns devices/models. Hook specs (`on_narrator_proposal`, `on_narrator_apply`) ship via `comfyvn/core/modder_hooks.py`; docs refreshed in `README.md`, `architecture.md`, `docs/NARRATOR_SPEC.md`, `docs/LLM_ORCHESTRATION.md`, `docs/development_notes.md`, and `CHANGELOG.md`, with CI coverage via `tools/check_current_system.py --profile p2_narrator`.
- Playground tiers & offline Stage (2025-12-02): Center router attaches `PlaygroundView` when `enable_playground` is toggled on, exposing Tier-0 parallax and Tier-1 Stage3D inside the Studio tab stack. Snapshots emit deterministic `render_config.json` payloads + hook events consumed by Codex A flows. Stage3D is now self-contained—`viewport.html` relies on vendored Three.js/VRM modules under `comfyvn/playground/stage3d/vendor/`, keeping the WebGL stage operational without CDN access. Docs refreshed (`docs/PLAYGROUND.md`, `docs/3D_ASSETS.md`, `README.md`) with flag guidance, hook surfaces, and offline setup notes.
- Secrets Vault & Sandbox Guard (2025-11-25): Introduced `comfyvn/security/{secrets_store,sandbox}.py` for encrypted secrets, audit logging, and deny-by-default plugin networking. Feature flags `enable_security_api` and `enable_security_sandbox_guard` gate `/api/security/*` endpoints plus allowlist enforcement. Modder hooks gained `on_security_secret_read`, `on_security_key_rotated`, and `on_sandbox_network_blocked`, and audit lines land in `logs/security.log`. Docs updated (`README.md`, `architecture.md`, `architecture_updates.md`, `CHANGELOG.md`, `docs/dev_notes_modder_hooks.md`) with a new companion note `docs/dev_notes_security.md`; regression coverage via `tests/test_security_secrets_store.py`, `tests/test_sandbox_network.py`, `tests/test_security_api.py`.

- Policy Enforcer & Audit (2025-10-22): Added `comfyvn/policy/{enforcer,audit}.py`, feature flag `enable_policy_enforcer`, and FastAPI routes `/api/policy/enforce` + `/api/policy/audit`. Import/export flows call the enforcer before writing to disk; JSONL logs accumulate under `logs/policy/enforcer.jsonl`, audit exports save to `logs/policy/policy_audit_<ts>.json`, and the modder hook bus now streams `on_policy_enforced` envelopes for contributor dashboards. Documentation sweep: `README.md`, `architecture.md`, `CHANGELOG.md`, `docs/development_notes.md`, `docs/dev_notes_modder_hooks.md`, and new note `docs/development/policy_enforcer.md`; regression coverage via `tests/test_policy_enforcer.py`.
- Live Collaboration & Presence (2025-11-22): Replaced the legacy lock-based collab stub with `comfyvn/collab/{crdt,room}.py`, a Lamport clock CRDT that keeps scene fields, nodes, and script lines convergent across clients. FastAPI hub (`comfyvn/server/core/collab.py`, `server/modules/collab_api.py`) now exposes `/api/collab/ws` plus REST helpers (`health`, `presence/{scene}`, `snapshot/{scene}`, `history/{scene}`, `flush`), guarded by feature flag `enable_collaboration` (defaults to true). Structured log lines (`collab.op applied ...`) land in `logs/server.log`, and the modder hook bus publishes `on_collab_operation` envelopes mirroring WebSocket broadcasts. GUI wiring (`comfyvn/gui/services/collab_client.py`, `SceneCollabAdapter`) diffs node editor changes into CRDT ops, renders presence/lock overlays in `TimelineView`, and applies remote snapshots automatically. Documentation sweep: `README.md`, `architecture.md`, `architecture_updates.md`, `CHANGELOG.md`, `docs/development_notes.md`, `docs/dev_notes_modder_hooks.md`, new checklist `docs/DEBUG_SNIPPETS/STUB_DEBUG_BLOCK.md`; regression coverage via new CRDT unit tests (`tests/test_collab_crdt.py`) and websocket harness additions.
- Battle Sim v0, Props Manager, Weather Overlays (2025-12-01): `comfyvn/battle/engine.py` now exposes the v0 formula, seeded resolve narration, and roll breakdowns; `/api/battle/simulate` is gated by `enable_battle_sim` and hooks `on_battle_resolved/on_battle_simulated` carry the new fields. Props gained `comfyvn/props/manager.py` + `/api/props/{anchors,ensure,apply}` behind `enable_props`, emitting `on_prop_applied`. Weather planner picked up LUT metadata, bake flags, and renamed hook `on_weather_changed` with feature flag `enable_weather_overlays`. Docs refreshed (`README.md`, `architecture.md`, `architecture_updates.md`, `docs/BATTLE_DESIGN.md`, `docs/PROPS_SPEC.md`, `docs/WEATHER_PROFILES.md`, `docs/VISUAL_STYLE_MAPPER.md`, `docs/dev_notes_modder_hooks.md`; changelog updated) and tests cover battle routes, props routes, and weather routes.
- Rating Matrix & SFW Gate (2025-11-18): Landed `comfyvn/rating/classifier_stub.py` with JSON-backed overrides/acks, mounted `/api/rating/{matrix,classify,overrides,ack,acks}` behind `enable_rating_api`, and wired SFW gating into `/api/llm/test-call` plus `RenPyOrchestrator.export`. Exports embed `{rating, rating_gate}` in `export_manifest.json`, the CLI honours `--rating-ack-token/--rating-acknowledged`, and modder hooks (`on_rating_decision`, `on_rating_override`, `on_rating_acknowledged`) broadcast when `enable_rating_modder_stream` is enabled. Docs refreshed (`README.md`, `architecture.md`, `architecture_updates.md`, `CHANGELOG.md`, `docs/dev_notes_rating_gate.md`).
- Observability & Privacy Telemetry (2025-11-19): Added `comfyvn/obs/{anonymize.py,telemetry.py}` with keyed BLAKE2s hashing, anonymous installation ids, and the `TelemetryStore` singleton that persists opt-in feature counters, modder hook samples, and crash digests under `logs/telemetry/usage.json`. FastAPI exposes `/api/telemetry/{summary,settings,events,features,hooks,crashes,diagnostics,health,opt_in}` with dry-run defaults; the umbrella flag `enable_observability` (legacy `enable_privacy_telemetry`) plus `enable_crash_uploader` stay false for external deployments, and consent writes to `config/comfyvn.json → telemetry`. Crash reporter integration registers reports when uploads are enabled, and diagnostics exports bundle scrubbed manifests + feature counts. Docs updated (`README.md`, `architecture.md`, `architecture_updates.md`, `CHANGELOG.md`, `docs/development_notes.md`, `docs/OBS_TELEMETRY.md`, `docs/development/observability_debug.md`), and regression coverage landed in `tests/test_observability.py`.
- Diff/Merge & Worldline Graph (2025-11-21): Added `comfyvn/diffmerge/{scene_diff,worldline_graph}.py` for POV-aware scene diffs and timeline graph assembly, mounted `/api/diffmerge/{scene,worldlines/graph,worldlines/merge}` behind `enable_diffmerge_tools`, registered new modder hooks (`on_worldline_diff`, `on_worldline_merge`), and landed the Studio **Worldline Graph** dock (`comfyvn/gui/panels/diffmerge_graph_panel.py`) with merge preview/apply wiring. Docs refreshed (`README.md`, `architecture.md`, `CHANGELOG.md`, `docs/dev_notes_modder_hooks.md`, `docs/development/diffmerge_worldline_graph.md`); regression coverage via `tests/test_diffmerge_routes.py`.
- Accessibility & Input Profiles (2025-11-29): Introduced the accessibility stack (`comfyvn/accessibility/{__init__,filters,subtitles,input_map}.py`) with persisted font scaling, high-contrast palette toggles, colorblind overlays, subtitle overlays, and controller-aware input bindings. Feature flags `enable_accessibility_controls`, `enable_accessibility_api`, and `enable_controller_profiles` gate the Settings drawers and REST surfaces; structured logs land in `logs/accessibility.log`. FastAPI now exposes `/api/accessibility/{state,filters,subtitle,input-map,input/event}`, while the Modder Hook Bus gained `on_accessibility_settings`, `on_accessibility_subtitle`, `on_accessibility_input_map`, and `on_accessibility_input`. VN Viewer consumes the manager for live overlays and remapped navigation. Docs refreshed (`README.md`, `architecture.md`, `architecture_updates.md`, `CHANGELOG.md`, `docs/dev_notes_modder_hooks.md`) and new note `docs/development/accessibility_input_profiles.md` captures payloads, feature flag defaults, and integration advice.
- Performance Budgets & Profiler Dashboard (2025-11-14): Introduced `comfyvn/perf/{budgets,profiler}.py` plus the shared singletons in `comfyvn/perf/__init__.py`, wired FastAPI routes under `/api/perf/*` for limit configuration, lazy asset eviction, job lifecycle helpers, profiler marks, and dashboard snapshots. Added feature flags (`enable_perf_budgets`, `enable_perf_profiler_dashboard`), modder hook envelopes (`on_perf_budget_state`, `on_perf_profiler_snapshot`), and `jobs_api` integration so over-budget submissions are delayed gracefully. Documentation sweep spans `README.md`, `architecture.md`, `architecture_updates.md`, `CHANGELOG.md`, and the new `docs/development/perf_budgets_profiler.md`; regression coverage landed in `tests/test_perf_budgets.py` and `tests/test_perf_profiler.py`.
- Steam & itch Export Publish (2025-11-15): Added shared helpers at `comfyvn/exporters/publish_common.py` plus platform packagers (`steam_packager.py`, `itch_packager.py`) that assemble deterministic archives, license manifests, provenance sidecars, and optional debug hook listings. `/api/export/publish` (behind `enable_export_publish*` flags) now orchestrates the Ren'Py export, honours dry-run previews, emits modder hooks (`on_export_publish_preview`, `on_export_publish_complete`), and records entries to `logs/export/publish.log`. Docs refreshed (`README.md`, `architecture.md`, `architecture_updates.md`, `CHANGELOG.md`, `docs/dev_notes_modder_hooks.md`) and a dedicated developer note lives at `docs/development/export_publish_pipeline.md`; regression coverage added via `tests/test_publish_packagers.py`.
- Modder Hook Bus & Debug Integrations (2025-10-21): Introduced `comfyvn/core/modder_hooks.py` with plugin-aware fanout, asset registry + scenario runner emitters, and a REST/WS surface under `/api/modder/hooks` (history + webhook management). Wired a Debug Integrations Studio panel to poll provider health/quota endpoints with masked credentials, refreshed README/architecture docs, CHANGELOG, and `docs/dev_notes_modder_hooks.md`, and recorded the work order in `docs/CODEX_STUBS/2025-10-21_MODDER_HOOKS_DEBUG_API_A_B.md`.
- Modder asset hook extensions (2025-11-11): AssetRegistry now emits enriched envelopes (`on_asset_saved`, `on_asset_registered`, `on_asset_meta_updated`, `on_asset_removed`, `on_asset_sidecar_written`) carrying asset type, metadata, and sidecar paths; `/api/modder/hooks` plus `/assets/debug/{hooks,modder-hooks,history}` mirror the same payloads for automation without requiring custom dashboards. Documentation sweep refreshed `README.md`, `architecture.md`, `CHANGELOG.md`, `docs/dev_notes_modder_hooks.md`, `docs/dev_notes_asset_registry_hooks.md`, and `docs/development_notes.md` to highlight the expanded fields and WebSocket/webhook usage.
- Weather, Lighting & Transitions (2025-11-09): Added `comfyvn/weather/engine.py` + `WeatherPlanStore` singleton (`WEATHER_PLANNER`), mounted `/api/weather/state` with structured logging, feature flag (`enable_weather_planner` → superseded by `enable_weather_overlays`), and initial `on_weather_plan` hook (now `on_weather_changed`). Docs refreshed (`README.md`, `architecture.md`, `CHANGELOG.md`, `docs/dev_notes_modder_hooks.md`), and reference material lives at `docs/WEATHER_PROFILES.md` with curl snippets + exporter guidance.
- Prompt pack documentation (2025-11-12): Published `docs/PROMPT_PACKS/POV_REWRITE.md` and `docs/PROMPT_PACKS/BATTLE_NARRATION.md` with system/user templates, guardrails, and router hints so narrative tooling can stay in lockstep with scenario/battle APIs. README, architecture docs, and LLM recommendations now reference the new packs alongside the existing `comfyvn/models/prompt_packs/` templates.
- Public Image & Video APIs (2025-11-10): Introduced dedicated feature flags (`enable_public_image_providers`, `enable_public_video_providers`) with Settings panel toggles, wired dry-run adapters for Stability, fal.ai, Runway, Pika, and Luma under `comfyvn/public_providers/*`, and mounted `/api/providers/{image,video}/{catalog,generate}` via `comfyvn/server/routes/providers_image_video.py`. Task registry jobs now log cost estimates for each request, the README/architecture docs reflect the new flow, and modder guidance landed in `docs/dev_notes_public_media_providers.md`.
- POV Worldlines & Timelines (2025-11-06): Added `comfyvn/pov/worldlines.py` with thread-safe registry + `Worldline` dataclass, `comfyvn/pov/timeline_worlds.py` diff/merge helpers, and FastAPI surface `/api/pov/worlds|/diff|/merge` under `comfyvn/server/routes/pov_worlds.py`. The Ren'Py orchestrator now honours `ExportOptions.world_id/world_mode`, embeds world selections in `export_manifest.json`, and CLI/server wrappers expose `--world`/`--world-mode`. Docs refreshed (`README.md`, `architecture.md`, `CHANGELOG.md`, `docs/POV_DESIGN.md`, `docs/dev_notes_modder_hooks.md`) and a dedicated note landed at `docs/development/pov_worldlines.md` plus codex stub `docs/CODEX_STUBS/2025-10-21_POV_WORLDLINES_TIMELINES_A_B.md`.
- Remote Installer Orchestrator (2025-11-09): Introduced `comfyvn/remote/installer.py` with module registry + status/log helpers, gated `/api/remote/{modules,install}` routes, and a new feature flag (`enable_remote_installer` default false). Each run records `logs/remote/install/<host>.log` and status manifests under `data/remote/install/`, keeping remote provisioning idempotent; dry-run mode emits the plan without mutating state. Docs/notes swept (`README.md`, `architecture.md`, `CHANGELOG.md`, `docs/development_notes.md`, `docs/CODEX_STUBS/2025-10-21_REMOTE_INSTALLER_ORCHESTRATOR_A_B.md`), and tests landed at `tests/test_remote_installer_api.py` to ensure no-op replays and dry-run behaviour.
- Battle Layer Choice & Sim (2025-11-06): Introduced `comfyvn/battle/engine.py` for deterministic outcomes + seeded narration, added `comfyvn/server/routes/battle.py` with `/api/battle/{resolve,simulate}`, and wired Scenario Runner overlays to show simulated logs while leaving branches pending. Docs refreshed (`README.md`, `architecture.md`, `docs/development/battle_layer_hooks.md`, `docs/dev_notes_modder_hooks.md`) and stub `docs/CODEX_STUBS/2025-10-21_BATTLE_LAYER_CHOICE_SIM_A_B.md` records the work order.
- Theme & World Changer (2025-11-05): Added `comfyvn/themes/templates.py` (LUT/music/prompt/asset/character role presets) plus `/api/themes/{templates,apply}` for checksum-stable plan deltas and per-character overrides. Documentation landed in `docs/development/theme_world_changer.md`, README, architecture docs, and the codex stub; regression coverage lives in `tests/test_theme_routes.py`.
- Public Translation/OCR/Speech blueprint (2025-11-07): Audited existing translation manager + TM review stubs, codified upcoming provider adapters under `comfyvn/public_providers/*`, introduced feature flags (`enable_public_translation_apis`, `enable_public_ocr_apis`, `enable_public_speech_apis`) defaulting to false, documented dry-run diagnostics via `/api/providers/{translate,ocr,speech}/test`, and published modder guidance in `docs/development/public_translation_ocr_speech.md` alongside README/architecture/CHANGELOG updates.
- View State Router & Feature Flags (2025-11-05): `comfyvn/gui/central/center_router.py` now orchestrates the VN Viewer and Character Designer with session-backed view persistence, hot-swappable quick actions (Assets/Timeline/Logs), and inline narrator playback when the chat overlay is enabled. `comfyvn/config/feature_flags.py` drives a shared cache for `enable_comfy_bridge_hardening`, `enable_comfy_preview_stream`, `enable_sillytavern_bridge`, and `enable_narrator_mode`, with consumer modules (`MainWindow`, `SettingsPanel`, `world_loader`, `st_sync_manager`, `bridge/st_bridge/health.py`, `gui/world_ui.py`) honoring the toggles live. Settings → Debug & Feature Flags exposes the new switches; SillyTavern helpers disable gracefully when the bridge flag is off; narrator mode injects the VN Chat panel directly beneath the viewer; preview stream gating avoids unnecessary ComfyUI polling. Docs refreshed in `README.md`, `architecture.md`, `CHANGELOG.md`, `docs/dev_notes_modder_hooks.md`, and new stub `docs/CODEX_STUBS/2025-10-21_VIEW_STATE_ROUTER_AND_FLAGS_A_B.md`.

- Ren'Py POV forks (2025-11-02): `RenPyOrchestrator` now derives perspective routes from timeline + scene metadata, writes manifest `pov` sections (mode/menu/default/routes/forks), and stages per-POV forks under `build/renpy_game/forks/`. The CLI gained `--pov-mode` and `--no-pov-switch`; publish emits master + per-POV archives with matching manifests/checksums. Docs refreshed (`README.md`, `architecture.md`, `docs/CODEX_STUBS/2025-10-21_EXPORT_PLAYABLE_POV_FORKS_A_B.md`) with debug hooks for contributors and modders.
- Chat & Narrator Mode (2025-10-21): new `comfyvn/gui/central/chat_panel.py` dock wired into MainWindow (Modules → VN Chat) mirrors SceneStore dialogue, includes a narrator autoplay toggle, and prepares payloads for the upcoming `/api/llm/chat` router. Until that endpoint lands, reuse `/api/llm/test-call` or runtime adapters for debugging. `collect_session_context` + `SillyTavernBridge.get_active()` remain exposed for tooling. Docs aligned (`README.md`, `architecture.md`, `docs/CODEX_STUBS/2025-10-21_CHAT_AND_NARRATOR_MODE_A_B.md`).
- Phase 6 integration (2025-10-30): SillyCompatOffload emulation engine (`comfyvn/emulation/engine.py`), `/api/emulation/*` feature flag toggle, LLM proxy routes (`/api/llm/{registry,prompt-pack,chat}`), prompt packs under `comfyvn/models/prompt_packs/`, and registry defaults in `comfyvn/models/registry.json`. Docs: `docs/LLM_RECOMMENDATIONS.md`, `docs/development/emulation_and_llm.md`.
- Phase 6 progression: audio cache manager (`comfyvn/core/audio_cache.py`), `/api/music/remix` stub, GUI audio panel hooked to new endpoints, and ComfyUI workflow guide (`docs/comfyui_music_workflow.md`) for real pipelines.
- Phase 6 pivot (POV & viewer): `TimelineView` merges the node editor, timeline, and Scenario Runner; the runner drives `/api/scenario/run/step`, `/api/pov/{get,set,fork,candidates}`, exposes seeds/variables/breakpoints, and refreshes directly from the node editor scene provider. FastAPI mounts `/api/viewer/{start,stop,status}` for Ren'Py launches (with log tailing under `logs/viewer/`), while Studio’s Log Hub panel tails runtime logs and the Settings panel’s **Debug & Feature Flags** drawer persists `enable_comfy_bridge_hardening` to `config/comfyvn.json`. `docs/POV_DESIGN.md` and `docs/VIEWER_README.md` capture the contracts; `docs/LLM_RECOMMENDATIONS.md` stays aligned for adapter toggles.
- Character Designer center (2025-11-01): new Studio tab pairs the VN Viewer with a CRUD + render dashboard; `data/characters/<id>/character.json` replaces flat files (legacy mirrors retained), LoRA attachments persist to `lora.json`, FastAPI exposes `/api/characters{,/save,/render}`, and hardened renders auto-register assets with provenance + thumbnails for modder automation.
- POV render pipeline (2025-10-30): `comfyvn/pov/render_pipeline.py` orchestrates hardened ComfyUI renders tied to `/api/pov/render/switch`, caches results by `(character, style, pose)`, mirrors ComfyUI sidecars alongside registered assets, and surfaces LoRA payload + workflow ids through asset metadata so modders can diff provenance.
- Phase 7 progression: policy gate + filter endpoints (`policy_api.py`), settings-backed acknowledgements, and advisory-friendly filter previews documented for debugging.
- Runtime storage overhaul: `comfyvn/config/runtime_paths.py` centralises log/config/cache/data directories via `platformdirs`, relocates mutable assets to user-space folders, exposes overrides (`COMFYVN_RUNTIME_ROOT`, `COMFYVN_LOG_DIR`, etc.), and provisions optional symlink shims for legacy `logs/` / `data/settings` references.
- Extension compatibility enforcement: `extensions_discovery` validates `extension.json` manifests (semantic `requires`, entrypoints, API hints), `menu_runtime_bridge` now supports callable callbacks, and GUI reloads surface incompatibilities via the new warning toast log.
- Timeline builder pass: new `TimelineRegistry` + dockable Timeline panel provide drag/drop sequences, notes per entry, and persistence for multiple timelines per project.
- World lore pipeline: seeded default `data/worlds/default_world.json`, `world_prompt.build_world_prompt()` converts SillyTavern-style lore into ComfyUI prompt text with trace metadata, and documentation captured in `docs/world_prompt_notes.md`.
- Sprite & pose controls: `SpritePanel` exposes persona expression switching, sprite previews, and pose assignment via `PoseManager`; persona metadata now retains the applied pose for ComfyUI exports.
- Player persona roster: PersonaManager now persists active player/character state, `/player/*` APIs expose roster + import hooks, and the GUI Player Persona panel drives active selection with live metadata previews.
- Offline LLM registry: provider templates add a `local_llm` runtime, packaged node sets include the ComfyUI LLM bridge, and persona defaults embed offline dialogue profiles for air-gapped production.
- LLM registry service: `comfyvn/models/registry.json` seeds provider-neutral metadata, adapters live under `comfyvn/models/adapters/*`, and `/api/llm/{registry,chat}` exposes the listing + proxy. Docs call out per-module tuning in `docs/LLM_RECOMMENDATIONS.md` with modder hooks in `docs/dev_notes_modder_hooks.md`.
- Workflow templates expanded: ComfyUI-ready specs (`sprite_composite_basic`, `pose_blend_basic`, `sprite_pose_composite`) landed with runtime stubs so GUI requests can be simulated without a running ComfyUI instance.
- Production workflows baseline: `comfyvn/bridge/{comfy,tts,remote}.py` provide REST + TTS + remote compute wiring, provider templates live in `comfyvn/providers/`, canonical graphs ship under `comfyvn/workflows/` (`sprite_pack.json`, `scene_still.json`, `video_ad_evolved.json`, `voice_clip_xtts.json`), and `tools/lock_nodes.py` regenerates `nodeset.lock.json` from local nodes.
- SillyTavern bridge now reads configurable settings (base URL + plugin path), the ST extension exposes `/comfyvn/roots` for source directories, and roleplay imports persist raw/processed/final transcripts with detail-level aware LLM passes + editor endpoints (`/preview/{scene_uid}`, `/apply_corrections`, `/sample_llm`).
- SillyTavern compatibility (Parts A/B): `/st/health` merges ping stats with extension + plugin version comparisons, `collect_extension_status` flags plugin mismatches via `plugin_needs_sync`, and `/st/session/sync` posts VN scene/POV/variable context to SillyTavern, returning a panel-ready reply under a 2 s timeout. Docs updated (`README.md`, `architecture.md`, `docs/dev_notes_modder_hooks.md`, `docs/CODEX_STUBS/2025-10-21_SILLY_COMPAT_AND_SESSION_SYNC_A_B.md`) to broadcast debug hooks, watch paths, and payload schemas.

Recent Changes Observed
----------------------
- CLI (`comfyvn/cli.py`) unified under Typer with `bundle`, `manifest`, `check`, `login`, and `scenes` commands; logging initialised per subcommand.
- Scene bundle workflow is now tracked: `comfyvn/scene_bundle.py`, `docs/scene_bundle.md`, and `tests/test_scene_bundle.py` landed with schema validation hooks.
- `run_comfyvn.py` enhanced with logging normalization (launcher/gui/server log separation) and venv bootstrap. Logging aligns with Phase 1 Part C requirement.
- Scenario Runner dock wired into the Studio timeline: `comfyvn/gui/debug/runner_panel.py` streams seed/POV/variable state, honours breakpoints, and syncs its scene payload from the node editor; `/api/pov/*` and `/api/scenario/run/step` handle the backend flow.
- Viewer routes (`/api/viewer/{start,stop,status}`) now fall back to `/api/viewer/web/{token}/{path}` (Ren'Py Web bundle) or Mini-VN previews (`/api/viewer/mini/{snapshot,refresh,thumbnail}`) when native embedding fails. Status exposes `runtime_mode`, cached thumbnail digests, and feature flags `enable_viewer_webmode` / `enable_mini_vn` gate the behaviour.
- Log Hub dock (`comfyvn/gui/widgets/log_hub.py`) tails GUI/server/advisory/render logs from the runtime directory, giving designers a quick checkpoint; Settings → Debug & Feature Flags persists `enable_comfy_bridge_hardening` in `config/comfyvn.json` so hardened ComfyUI submissions can be toggled without hand-editing JSON.
- Base URL authority module (`comfyvn/config/baseurl_authority.py`) centralises host/port resolution: `COMFYVN_BASE_URL` → runtime state file → `settings/config.json` → `comfyvn.json` → default. `run_comfyvn.py` writes the bound host/port back to `config/runtime_state.json` and exports `COMFYVN_SERVER_BASE`/`COMFYVN_BASE_URL` for child processes while `/settings/{set,save}` continues to use the shared `SettingsManager` with deep-merge semantics.
- Asset registry thumbnail generation now happens via a shared background worker so large image imports stop blocking the registration path, and audio/voice assets embed provenance markers when Mutagen is available (MP3/OGG/FLAC/WAV).
- GUI shell updates: menu rebuilt under “Modules” top-level, ServerBridge polling 3s cadence, dock tabification to prevent module overlap. This satisfies Phase 1 Part B acceptance criteria from the architecture doc.
- Presentation planning shim: `comfyvn/presentation/directives.py` defines atomic directive compilation, `/api/presentation/plan` exposes the planner, and the Scenes view embeds a non-blocking preview widget to display compiled plans in JSON form.
- Server bootstrap repaired: `comfyvn/server/app.py` now exposes `create_app()`, enables CORS, configures logging, and registers `/health` + `/status`, fulfilling Phase 1 Part A.
- Legacy entrypoint aligned: `comfyvn/app.py` delegates to the canonical factory, preserves `/healthz` for legacy probes, and documents the logging/debug flow.
- GUI detached-server helper updated to launch `python comfyvn/app.py`, matching the new entrypoint behaviour and writing to `server_detached.log` in the user log directory.
- Phase 2 migration script expanded (`setup/apply_phase06_rebuild.py`) adding project-aware columns and registry tables (variables, templates, providers, settings). Asset registry exposes `register_file` with sidecar output.
- Phase 5 compute span landed: `comfyvn/core/gpu_manager.py`, `/api/gpu/*`, `/api/providers/*`, and `/compute/advise` expose policy-aware device selection, provider health checks, and advisor rationale. Job metadata now includes the selected compute target, and registry/logging emits debug messages for troubleshooting.
- Phase 5 metrics/job queue completed: `/jobs/ws` streams registry updates via FastAPI WebSocket; `JobsPanel` consumes the stream with auto-reconnect + HTTP fallback, writing state changes to `gui.log` in the user log directory for diagnosis.
- VN importer pipeline landed: `comfyvn/server/core/vn_importer.py`, `/vn/import` API, GUI VN importer wiring, TaskRegistry-backed jobs (`/jobs/status/:id`), `GET /vn/import/{job_id}`, and per-import summaries archived under `data/imports/vn/*` for provenance/debugging. GUI follow-ups captured in `docs/gui_followups.md`.
- Arc/unpacker support: `/vn/tools/*` endpoints manage external extractor registrations with legal warnings, importer detects `.arc/.xp3` via registered binaries, and `extensions/tool_installer` surfaces installer docs for GUI integration.
- Documentation: `docs/importer_engine_matrix.md` outlines engine detection signatures + hook expectations; `docs/remote_gpu_services.md` captures provider catalog and advisor inputs for importer-driven GPU recommendations; `docs/tool_installers.md` expanded with config notes.
- Importer scaffolding landed (`comfyvn/importers/*`, `core/normalizer.py`, CLI `bin/comfyvn_import.py`) with comfyvn-pack schema writer and detection heuristics for Ren'Py, KAG, NScripter, Yu-RIS, CatSystem2, BGI, RealLive, Unity VN, TyranoScript, LiveMaker.
- `/api/gpu/advise` leverages new compute advisor heuristics to balance local VRAM vs. curated remote providers; recommendations include cost hints and provider notes for RunPod/Vast.ai/Lambda/AWS/Azure/Paperspace/unRAID.
- Extractor catalog expanded to top 20 community tools (Light.vnTools mirrors, GARbro, KrkrExtract, XP3 tools, CatSystem2/BGI/RealLive utilities, Unity asset rippers). `/vn/tools/catalog` lists metadata; `/vn/tools/install` downloads with license warnings and auto-registration.
- Studio API stubs (`comfyvn/server/modules/studio_api.py`) provide `/api/studio/open_project`, `/switch_view`, `/export_bundle`; `comfyvn/gui/studio_window.py` prototype consumes them via `ServerBridge.post`.
- Roleplay importer endpoints (`POST /roleplay/import`, `GET /roleplay/imports/{job_id}`) hardened: jobs/import rows now created via studio registries, scenes/characters persisted, transcripts registered as assets, and debug logs stored under the imports subfolder of the user log directory.
- Import observability expanded with `/roleplay/imports` listing and `/roleplay/imports/{job_id}/log` streaming so Studio panels can surface queues + logs without touching disk.
- Studio `RoleplayImportView` now binds to the importer endpoints, auto-refreshing every 10s and offering inline log viewing for rapid debugging.
- Studio main window now persists geometry/layout via `QSettings`, and File menu includes New/Close/Recent project actions above the folder shortcuts.
- Scenes/Characters/Imports/Audio/Advisory panels dockable via Modules menu, backed by registry/table endpoints for Phase 4 readiness.
- Assets router rebuilt: `/assets/*` delegates to `AssetRegistry` for list/detail/upload/register/delete, enforces metadata validation, and reuses thumbnail/sidecar helpers.
- Asset provenance pipeline added: `AssetRegistry.register_file` records provenance rows, stamps PNG metadata, returns ledger details, and honours license metadata; tests (`tests/test_asset_provenance.py`) and docs (`docs/studio_assets.md`) describe verification steps.
- Phase 0 scaffolding added: `setup/apply_phase06_rebuild.py`, `comfyvn/studio/core/*`, and `docs/studio_phase0.md`, moving toward Phase 2 “Data layer & registries”.

Gaps vs. Architecture Plan
--------------------------
- `architecture.md` expects StudioShell module (`gui/studio_window.py`) with sidebar/toolbar layout; prototype exists but the primary launcher still favours `main_window`. Decide on migration strategy or update documentation to reflect dual shells.
- Asset pipeline follow-up: wire UI/CLI progress indicators to the async thumbnail worker and document optional Mutagen installation so audio provenance tagging is predictable across environments.
- Importer and compute pipelines lack end-to-end regression tests; add fixtures that exercise `/vn/import`, `/roleplay/import` (list/log), and GPU advisor flows.
- Scripts location mismatch: architecture baseline lists `scripts/run_comfyvn.py`; repo keeps launcher at root. Decide whether to relocate or adjust documentation.

Immediate Repair / Follow-up Tasks
----------------------------------
1. **Studio shell decision (resolved for v0.8)**
   - Decision: Keep `MainWindow` as the primary Studio shell for v0.8; `StudioWindow` remains a lightweight prototype targeting new `/api/studio/*` endpoints.
   - Rationale: `MainWindow` integrates panels, menu registry, and stable polling; switching launchers now would risk regressions without clear user benefit.
   - Next: Fold the useful Studio toolbar actions into `MainWindow` and continue evolving `/api/studio/*` without changing the launcher.
2. **Provenance follow-ups**
   - Introduce background thumbnail worker and extend provenance stamping to audio/voice assets.
3. **Importer/compute regression suite**
   - Add pytest flows covering `/vn/import`, `/roleplay/import` (list/log/GUI), and GPU advisor endpoints to catch regressions.
4. **Docs alignment (started)**
   - `ARCHITECTURE.md` updated to clarify primary shell; launcher remains `comfyvn.gui.main_window` via `run_comfyvn.py`.
5. **Server API polish (resolved 2025-10-23)**
   - Renamed `RegisterAssetRequest.copy` → `copy_file` (kept alias) to silence the Pydantic warning without breaking callers.
   - Added `tests/test_settings_api.py::test_settings_save_deep_merge` to lock deep-merge semantics and `tests/test_launcher_smoke.py` to exercise the launcher `/health` + `/status` smoke path.
   - Documentation touch-up: `docs/studio_assets.md` now explains the new `copy_file` request flag (legacy `copy` still accepted).
  - Roleplay importer responses now include `logs_path`, tests read the runtime log location instead of assuming the legacy `logs/imports/` folder, and async VN import polling waits for the returned summary to avoid flakes.

Use this document as a working checklist while bringing the repo back in sync with the architectural intent.
- Asset Registry Filters & Hook Bus (2025-11-10): Expanded `/assets` list filters to cover `type`, `hash`, `tag`/`tags`, and `q` for substring matching, refreshed `AssetRegistry.list_assets` accordingly, and broadened the modder hook spec with `on_asset_registered`, `on_asset_meta_updated`, `on_asset_sidecar_written`, and `on_asset_removed`. Documented the workflow across README, `architecture.md`, `docs/development_notes.md`, `docs/dev_notes_modder_hooks.md`, and the new `docs/development/asset_debug_matrix.md`, plus added regression coverage in `tests/test_asset_registry_filters.py`.
