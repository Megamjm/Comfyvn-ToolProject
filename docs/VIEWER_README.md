# Viewer Quickstart — 2025-11-04

## Purpose
- Launch or embed a Ren’Py viewer directly from the backend so Studio panels, CI probes, or helper scripts can preview builds without manual CLI steps.
- Provide a unified log/diagnostic path (`logs/viewer/renpy_viewer.log`) regardless of which frontend requested the launch.
- Record the minimal payload contract for `/api/viewer/{start,stop,status}` so automation and GUI features stay in sync.

## Launch Requirements & Decision Tree
- Minimum input: a Ren'Py project directory (default `./renpy_project`). Override with `COMFYVN_RENPY_PROJECT_DIR` or pass `{"project_path": ...}`.
- Runtime probes (in order):
  1. Explicit payload `renpy_executable` (or `COMFYVN_RENPY_EXECUTABLE`).
  2. `renpy_sdk` payload / `COMFYVN_RENPY_SDK` env → resolves to `renpy.sh`/`renpy.exe`.
  3. `renpy` available on `$PATH`.
  4. Importable `renpy` module (`python -m renpy`).
- Fallback decision tree when native launch fails:
  1. **Native embed** (window ID captured for Qt embedding).
  2. **Web fallback** — serves the `project/web/index.html` bundle via `/api/viewer/web/...` and embeds it inside the Qt pane when WebEngine is available.
  3. **Mini-VN** — deterministic preview using the headless player + thumbnailer. Shows instantly in the GUI and drives timeline thumbnail caching.
- The same decision tree is re-applied whenever the native process exits mid-run; the next `/api/viewer/status` poll tears down the stale state, records the exit code in `stub_reason`, and activates the next fallback automatically.
- Feature flags:
  - `enable_viewer_webmode` (default: true) gates the web fallback.
  - `enable_mini_vn` (default: true) controls the Mini-VN fallback.
  - Legacy Tk stub remains available if both fallbacks are disabled.

## API Surface
### `POST /api/viewer/start`
- Payload keys (all optional):
  - `project_path`: absolute or relative path to a Ren’Py project.
  - `project_id`: custom identifier stored in the process state (defaults to folder name).
  - `renpy_executable`: absolute path to the Ren’Py executable/launcher.
  - `renpy_sdk`: path to the Ren’Py SDK root; auto-resolves to `renpy.sh` / `renpy.exe`.
- Response example:

  ```json
  {
    "status": "running",
    "running": true,
    "pid": 12345,
    "project_path": "/home/user/ComfyVN/renpy_project",
    "project_id": "renpy_project",
    "mode": "renpy-sdk",
    "runtime_mode": "native",
    "command": ["/opt/renpy/renpy.sh", "/home/user/ComfyVN/renpy_project"],
    "log_path": "/home/user/.local/share/ComfyVN Studio/logs/viewer/renpy_viewer.log",
    "window_id": null,
    "stub_reason": null,
    "embed_attempted": true,
    "webview": null,
    "mini_vn": null
  }
  ```

- The backend spawns a background probe that attempts to capture the viewer window ID (Windows: HWND, Linux: X11 ID via `wmctrl`). When successful it appears in `window_id`.
- If native embedding fails and fallbacks are enabled, `runtime_mode` switches to `webview` or `mini-vn` and the payload includes:
  - `webview`: `{ "token": "...", "entry": "/api/viewer/web/<token>/index.html" }`
  - `mini_vn`: snapshot preview with deterministic digest (`mini_digest`) and thumbnail URLs.

### `POST /api/viewer/stop`
- Payload: `{}` (optional). Terminates the active viewer process, returns the same status payload with `"status": "stopped"`. Safe to call when no process is running.

### `GET /api/viewer/status`
- Returns the current process snapshot without mutating state. Use this to poll from Studio or CI loops. Status now includes fallback metadata (`runtime_mode`, `webview`, `mini_vn`, `mini_digest`).

### `GET /api/viewer/web/{token}/{path}`
- Serves files from the Ren'Py web distribution (`<project>/web`). `path` defaults to `index.html`.
- Tokens rotate on each start to prevent stale embeddings.

### `GET /api/viewer/mini/snapshot`
- Returns the active Mini-VN snapshot (identical to the payload nested under `mini_vn` in `/status`). Useful for automation that wants a single fetch without polling status.

### `POST /api/viewer/mini/refresh`
- Rebuilds the Mini-VN snapshot (`seed`/`pov` overrides optional). Useful after asset or timeline edits.

### `GET /api/viewer/mini/thumbnail/{token}/{key}`
- Streams cached thumbnails generated by the Mini-VN thumbnailer. URLs are provided via `mini_vn["thumbnails"][*]["url"]`.

## Environment & Tooling
- `COMFYVN_RENPY_PROJECT_DIR` — overrides the default project root.
- `COMFYVN_RENPY_EXECUTABLE` — absolute path to the Ren’Py launcher/binary.
- `COMFYVN_RENPY_SDK` — SDK directory containing `renpy.sh` / `renpy.exe`.
- `RENPY_HOME` is set automatically to the project path when the viewer launches.
- Feature flags persisted via `comfyvn.json`:
  - `enable_viewer_webmode` (default: true) — allow web fallback.
  - `enable_mini_vn` (default: true) — allow Mini-VN fallback and thumbnail capture.
- Logs live under `runtime_paths.logs_dir("viewer", "renpy_viewer.log")`. Tail the file or open Panels → Log Hub in Studio for a live feed.
- Pair with the Scenario Runner: launch the viewer, then use `/api/scenario/run/step` snapshots to drive scripted playthroughs while the viewer window stays in sync.

## Troubleshooting
- Missing project directory → `404` with `detail` field. Verify the path and ensure assets are exported.
- Missing runtime → service returns `mode: "stub"` with `stub_reason`. Install Ren’Py or point the payload/env vars to a valid binary and restart.
- Window detection failures are captured in `embed_fail_reason`; on Linux install `wmctrl` for best results.
- Web fallback disabled? Ensure `enable_viewer_webmode` remains true and that `<project>/web/index.html` exists (Ren'Py web build).
- Mini-VN fallback disabled? Toggle `enable_mini_vn` or inspect the server logs for miniature player exceptions.
- Viewer crashes leave the log handle open until `GET /api/viewer/status` is called; the next status poll resets the cached state.

## Related References
- `README.md` — high-level overview of viewer routes and environment flags.
- `docs/POV_DESIGN.md` — outlines Scenario Runner + POV integration that frequently pairs with viewer sessions.
- `comfyvn/server/routes/viewer.py` — reference implementation of the API surface.
