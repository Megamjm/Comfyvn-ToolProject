{
  "workflow_id": "sprite_pack_identity_lock_v0.6",
  "family": "sprite_sheet",
  "version": "0.6.0",
  "metadata": {
    "description": "Identity-locked sprite batch with ControlNet OpenPose and SpriteSheetMaker packing.",
    "packs": ["ipadapter_plus", "advanced_cn", "impact_pack", "layerstyle", "compositor", "sam2", "videohelper_vhs"],
    "expected_inputs": [
      "prompt",
      "negative_prompt",
      "character_seed",
      "pose_images[]",
      "ipadapter_face_refs[]",
      "style_refs[]"
    ],
    "outputs": [
      {
        "type": "image",
        "filename": "sprites/{{character_id}}/{{pose_id}}.png"
      },
      {
        "type": "atlas",
        "filename": "sprites/{{character_id}}/atlas.png",
        "sidecar": "sprites/{{character_id}}/atlas.json"
      }
    ],
    "seed_keys": ["character_seed", "detail_seed", "control_seed"]
  },
  "graph": {
    "last_node_id": 18,
    "last_link_id": 24,
    "nodes": [
      {
        "id": 1,
        "type": "CheckpointLoaderSimple",
        "class_type": "CheckpointLoaderSimple",
        "inputs": {
          "ckpt_name": "{{model_checkpoint}}"
        }
      },
      {
        "id": 2,
        "type": "IPAdapterModelLoader",
        "class_type": "IPAdapterModelLoader",
        "inputs": {
          "model": 1,
          "ipadapter_file": "{{ipadapter_faceid_model}}"
        }
      },
      {
        "id": 3,
        "type": "IPAdapterApply",
        "class_type": "IPAdapterApplyAdvanced",
        "inputs": {
          "weight": 0.75,
          "model": 1,
          "ipadapter": 2,
          "clip_vision": "{{clip_vision_model}}",
          "image": "{{ipadapter_face_refs}}",
          "style_strength": 0.35
        }
      },
      {
        "id": 4,
        "type": "ControlNetLoader",
        "class_type": "ControlNetLoader",
        "inputs": {
          "control_net_name": "{{controlnet_openpose_model}}"
        }
      },
      {
        "id": 5,
        "type": "ControlNetApplyAdvanced",
        "class_type": "ControlNetApplyAdvanced",
        "inputs": {
          "strength": 0.55,
          "strength_end": 0.2,
          "model": 3,
          "control_net": 4,
          "image": "{{pose_images}}"
        }
      },
      {
        "id": 6,
        "type": "CLIPTextEncode",
        "class_type": "CLIPTextEncode",
        "inputs": {
          "text": "{{prompt}}",
          "clip": 1
        }
      },
      {
        "id": 7,
        "type": "CLIPTextEncode",
        "class_type": "CLIPTextEncode",
        "inputs": {
          "text": "{{negative_prompt}}",
          "clip": 1
        }
      },
      {
        "id": 8,
        "type": "EmptyLatentImage",
        "class_type": "EmptyLatentImage",
        "inputs": {
          "width": "{{width}}",
          "height": "{{height}}",
          "batch_size": "{{pose_count}}"
        }
      },
      {
        "id": 9,
        "type": "KSampler",
        "class_type": "KSampler",
        "inputs": {
          "model": 5,
          "seed": "{{character_seed}}",
          "steps": "{{sampler_steps}}",
          "cfg": "{{sampler_cfg}}",
          "sampler_name": "{{sampler}}",
          "scheduler": "{{scheduler}}",
          "positive": 6,
          "negative": 7,
          "latent_image": 8
        }
      },
      {
        "id": 10,
        "type": "VAEDecode",
        "class_type": "VAEDecode",
        "inputs": {
          "samples": 9,
          "vae": 1
        }
      },
      {
        "id": 11,
        "type": "ImageScaleBy",
        "class_type": "ImageScaleBy",
        "inputs": {
          "image": 10,
          "scale_by": "{{upscale_factor}}",
          "method": "lanczos"
        }
      },
      {
        "id": 12,
        "type": "ImpactFaceDetailer",
        "class_type": "ImpactFaceDetailer",
        "inputs": {
          "image": 11,
          "detailer_strength": 0.45,
          "seed": "{{detail_seed}}",
          "refiner": "{{detailer_model}}"
        }
      },
      {
        "id": 13,
        "type": "MaskExpand",
        "class_type": "MaskExpand",
        "inputs": {
          "mask": "{{sam2_mask}}",
          "expand": 16,
          "feather": 12
        }
      },
      {
        "id": 14,
        "type": "BlendImageWithMask",
        "class_type": "BlendImageWithMask",
        "inputs": {
          "background": "{{background_image}}",
          "foreground": 12,
          "mask": 13
        }
      },
      {
        "id": 15,
        "type": "SaveImage",
        "class_type": "SaveImage",
        "inputs": {
          "filename_prefix": "sprites/{{character_id}}/{{pose_id}}",
          "images": 14
        }
      },
      {
        "id": 16,
        "type": "SpriteSheetMaker",
        "class_type": "SpriteSheetMaker",
        "inputs": {
          "images": 14,
          "rows": "{{atlas_rows}}",
          "cols": "{{atlas_cols}}",
          "padding": 6,
          "transparent": true,
          "manifest_path": "sprites/{{character_id}}/{{atlas_name}}.json",
          "cell_width": "{{cell_width}}",
          "cell_height": "{{cell_height}}",
          "order": "row-major"
        }
      },
      {
        "id": 17,
        "type": "SaveImage",
        "class_type": "SaveImage",
        "inputs": {
          "filename_prefix": "sprites/{{character_id}}/{{atlas_name}}",
          "images": 16
        }
      },
      {
        "id": 18,
        "type": "SaveText",
        "class_type": "SaveText",
        "inputs": {
          "text": "{{atlas_manifest_json}}",
          "filename_prefix": "sprites/{{character_id}}/{{atlas_name}}"
        }
      }
    ],
    "links": [
      [1, 0, 3, 0, 1],
      [1, 0, 12, 2, 2],
      [1, 2, 10, 1, 3],
      [3, 0, 5, 0, 4],
      [4, 0, 5, 1, 5],
      [5, 0, 9, 0, 6],
      [6, 0, 9, 5, 7],
      [7, 0, 9, 6, 8],
      [8, 0, 9, 7, 9],
      [9, 0, 10, 0, 10],
      [10, 0, 11, 0, 11],
      [11, 0, 12, 0, 12],
      [12, 0, 14, 1, 13],
      [12, 0, 16, 0, 14],
      [13, 0, 14, 2, 15],
      [14, 0, 15, 0, 16],
      [16, 0, 17, 0, 17]
    ]
  }
}

