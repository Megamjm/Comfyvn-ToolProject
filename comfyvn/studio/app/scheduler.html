<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>ComfyVN Scheduler</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:1rem}
    pre{background:#111;color:#eee;padding:.75rem;max-height:70vh;overflow:auto}
    .row{display:flex;gap:.5rem;align-items:center}
    .inp{padding:.35rem .5rem;border:1px solid #bbb;border-radius:.3rem}
    .pill{padding:.35rem .6rem;border:1px solid #bbb;border-radius:.4rem;background:#f7f7f7;cursor:pointer}
  </style>
</head>
<body>
  <h2>Scheduler / Jobs</h2>
  <div class="row">
    <button id="btn" class="pill">Refresh</button>
    <label>API Key:</label><input id="k" class="inp" style="width:260px" placeholder="optional for /webhooks/*"/>
    <button id="btnHook" class="pill">Add Webhook</button>
    <button id="btnEmit" class="pill">Emit Test</button>
  </div>
  <pre id="out">ready</pre>
  <script>
  const out=document.getElementById("out");
  async function go(){
    const s=await fetch("/scheduler/health"); const sh=await s.json();
    const r=await fetch("/jobs/recent"); const jr=await r.json();
    out.textContent = JSON.stringify({scheduler:sh,recent:jr}, null, 2);
  }
  document.getElementById("btn").onclick=go; go();

  // SSE stream of job events
  try{
    const es=new EventSource("/events/jobs/events");
    es.onmessage=(e)=>{ try{
      const data = JSON.parse(e.data);
      out.textContent = JSON.stringify({sse:data}, null, 2) + "\n\n" + out.textContent.slice(0,4000);
    }catch{} };
  }catch(e){}

  async function postJSON(path, body, key){
    const h={"Content-Type":"application/json"};
    if (key) h["x-api-key"]=key;
    const r = await fetch(path,{method:"POST",headers:h,body:JSON.stringify(body)});
    return r.json();
  }
  document.getElementById("btnHook").onclick=async()=>{
    const key=document.getElementById("k").value.trim();
    const res=await postJSON("/webhooks/put",{event:"test",url:"http://localhost:0/noop"}, key);
    out.textContent=JSON.stringify(res,null,2);
  };
  document.getElementById("btnEmit").onclick=async()=>{
    const key=document.getElementById("k").value.trim();
    const res=await postJSON("/webhooks/emit",{event:"test",payload:{ok:true}}, key);
    out.textContent=JSON.stringify(res,null,2);
  };
  </script>
</body>
</html>
